<html>
<head>
<link rel="stylesheet" type="text/css" href="style.css">
<script src="jquery.js"></script>
<script src="jquery.bpopup.js"></script>
<script src="jsrender.min.js"></script>

<script id="tempTemplate" type="text/x-jsrender">
<div id="temp_{{:name}}" class="widget">
<div id="temp_{{:name}}_name" class="widget_title">{{:pretty_name}}</div>
<div id="temp_{{:name}}_body" class="widget_body">
  <div id="temp_{{:name}}_settings" class="widget_settings_icon">
    <img src="img/settings.png"></img>
  </div>
  <div id="temp_{{:name}}_temp"></div>
</div>
</div>
</script>

<script id="tempPidTemplate" type="text/x-jsrender">
<div class="widget_settings" id="pid_{{:name}}_setting" style="display:none">
<table border="1">
<tr><th>Set Point:</th><td><input type="text" id="pid_{{:name}}_set_point" /></td></tr>
<tr><th>P Term:</th><td><input type="text" id="pid_{{:name}}_p" /></td></tr>
<tr><th>I Term:</th><td><input type="text" id="pid_{{:name}}_i" /></td></tr>
<tr><th>D Term:</th><td><input type="text" id="pid_{{:name}}_d" /></td></tr>
<tr><th>pkt_1:</th><td id="pid_{{:name}}_pkt_1"></td></tr>
<tr><th>ekt_1:</th><td id="pid_{{:name}}_ekt_1"></td></tr>
</table>
<input type="submit" id="pid_{{:name}}_update" value="Update"/>
</div>
</script>

<script id="switchTemplate" type="text/x-jsrender">
<div id="switch_{{:name}}" class="widget">
<div id="switch_{{:name}}_name" class="widget_title">{{:pretty_name}}</div>
<div id="switch_{{:name}}_body" class="widget_body">
  <div id="switch_{{:name}}_value" class="switch_value"></div>
  <input type="submit" id="switch_{{:name}}_toggle" value="toggle"/>
</div>
</div>
</script>

<script type='text/javascript'>

var widgets = [];

function getStatus() {
             $.ajax({
                url: "/status",
                type: "POST",
                dataType: "json",
                success: function(status) {
                $.each(widgets, function(index, widget) {
                       widget.update(status);
                       });
                setTimeout(function() { getStatus(); }, 1000);
                },
                error: function( xhr, status ) {
                        console.log("error " + status);
                        console.log(xhr);
                },
        });
    }

TempWidget = function(name, pretty_name) {
    this.name = name;
    this.pretty_name = pretty_name;
    this.element =  $('#' + this.name);

    html = $.templates("#tempTemplate").render(this);
    this.element.html(html);

    this.display_element = $('#temp_' + this.name + '_temp');
    this.settings_element = $('#temp_' + this.name + '_settings');
    this.first_pass = true;
    this.settings_active = false;
}

TempWidget.prototype.update = function(status) {
    var temp = status["inputs"][this.name];
    this.display_element.text(parseFloat(temp).toFixed(1));

    var pid = this.name + "_pid";
    var params = status["parameters"];
    if (this.first_pass) {
        if (pid in params) {
            this.settings_element.show();
            html = $.templates("#tempPidTemplate").render(this);
            this.element.append(html);
            this.pid_element = $("#pid_" + this.name + "_setting");
            this.settings_element.bind('click', this, function(e) {
                                       e.preventDefault();
                                       e.data.settings_active = true;
                                       e.data.pid_element.bPopup();
                                       });
            $('#pid_' + this.name + '_update').bind('click', this, function(e) {
                                                    e.data.updatePidSettings();
                                                    });
            this.pid = {
                'set_point': $('#pid_' + this.name + '_set_point'),
                'p': $('#pid_' + this.name + '_p'),
                'i': $('#pid_' + this.name + '_i'),
                'd': $('#pid_' + this.name + '_d'),
                'pkt_1': $('#pid_' + this.name + '_pkt_1'),
                'ekt_1': $('#pid_' + this.name + '_ekt_1')
            };
        }
        this.first_pass = false
    }

    if ("pid" in this) {
        if (!this.settings_active) {
            this.pid['set_point'].val(params[pid].set_point.toFixed(1));
            this.pid['p'].val(params[pid].p.toFixed(2));
            this.pid['i'].val(params[pid].i.toFixed(2));
            this.pid['d'].val(params[pid].d.toFixed(2));
        }
        this.pid['pkt_1'].text(params[pid].pkt_1.toFixed(2));
        this.pid['ekt_1'].text(params[pid].ekt_1.toFixed(2));
    }

}

TempWidget.prototype.updatePidSettings = function() {
	var postData = {
		'set_point': parseFloat(this.pid['set_point'].val()),
		'p': parseFloat(this.pid['p'].val()),
		'i': parseFloat(this.pid['i'].val()),
		'd': parseFloat(this.pid['d'].val()),
	};
        var element = this.pid_element
	$.ajax({
    		url: "/params/" + this.name + "_pid/set",
    		type: "POST",
    		data: JSON.stringify(postData),
    		dataType: "json",
    		success: function(data) {
    			element.close();
    		},

    		error: function( xhr, status ) {
    			console.log("error " + status);
    			console.log(xhr);
    		},
    	});

}

SwitchWidget = function(name, pretty_name) {
    this.name = name;
    this.pretty_name = pretty_name;
    this.element =  $('#' + this.name);
    this.value = 0.0;

    html = $.templates("#switchTemplate").render(this);
    this.element.html(html);

    this.display_element = $('#switch_' + this.name + '_value');
    $('#switch_' + this.name + '_toggle').bind('click', this, function(e) {
                                            e.data.toggle();
                                            });
}

SwitchWidget.prototype.update = function(status) {
    var value = parseFloat(status["parameters"][this.name + "_control"]["control"]);
    this.value = value;
    if (value < 0.5) {
        this.display_element.text("recirculating");
    } else {
        this.display_element.text("transfering");
    }
}

SwitchWidget.prototype.toggle = function() {
    var new_value = 1.0 - this.value;
    var postData = {
        'control': new_value,
    };
    $.ajax({
            url: "/params/" + this.name + "_control/set",
            type: "POST",
            data: JSON.stringify(postData),
            dataType: "json",
            success: function(data) {
            },
            error: function( xhr, status ) {
                console.log("error " + status);
                console.log(xhr);
            },
            });

}

function init() {
    widgets.push(new TempWidget("hlt", "Hot Liquor Tank"))
    widgets.push(new TempWidget("rims", "RIMS Tube"))
    widgets.push(new TempWidget("mlt", "Mash Tun"))
    widgets.push(new TempWidget("boil", "Boil Kettle"))

    widgets.push(new SwitchWidget("hlt_valve", "HLT Valve"))
    widgets.push(new SwitchWidget("mlt_valve", "MLT Valve"))

    getStatus()
}
$(document).ready(function() {
                  init()
                  });
</script>


<title>mcp</title>
</head>
<body>
<div class="section">
<div id="hlt"></div>
<div id="rims"></div>
<div id="mlt"></div>
<div id="boil"></div>
</div>
<div class="section">
<div id="hlt_valve"></div>
<div id="mlt_valve"></div>
</div>
</body>
</html>
